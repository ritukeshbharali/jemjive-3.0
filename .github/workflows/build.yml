name: Build Jem-Jive Libraries

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # ---------------- CHECKOUT ----------------
      - name: Checkout source
        uses: actions/checkout@v4

      # ---------------- DEPENDENCIES ----------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential g++ \
            zlib1g-dev \
            libreadline-dev \
            freeglut3-dev \
            openmpi-bin openmpi-common libopenmpi-dev

      # ---------------- BUILD JEM ----------------
      - name: Build jem-3.0
        working-directory: jem-3.0
        run: |
          ./configure --cxx=mpic++
          make -j$(nproc)

      # ---------------- BUILD JIVE ----------------
      - name: Build jive-3.0
        working-directory: jive-3.0
        env:
          JEMDIR: ${{ github.workspace }}/jem-3.0
        run: |
          ./configure
          make -j$(nproc)

      # ---------------- PACKAGE EVERYTHING ----------------
      - name: Prepare JEM/JIVE build artifact
        run: |
          mkdir -p ./jemjive-build

          # Copy full directory trees
          cp -r ./jem-3.0 ./jemjive-build/jem-3.0
          cp -r ./jive-3.0 ./jemjive-build/jive-3.0

      # ---------------- UPLOAD FOLDER ARTIFACT ----------------
      - name: Upload jemjive-build folder
        uses: actions/upload-artifact@v4
        with:
          name: jemjive-build-folder
          path: ./jemjive-build